<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nutrition System Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
        }
        .test-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .test-result {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        h1, h2 {
            color: #2c3e50;
        }
        .emoji {
            font-size: 1.2em;
            margin-right: 5px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        button:hover {
            background-color: #2980b9;
        }
        #results {
            white-space: pre-wrap;
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }
    </style>
</head>
<body>
    <h1>🧪 Nutrition System Test</h1>
    
    <div class="test-container">
        <h2>Test Results</h2>
        <div id="results">Click "Run Tests" to start testing the nutrition system...</div>
        <button onclick="runTests()">Run Tests</button>
    </div>

    <script>
        // Mock localStorage for testing
        const mockLocalStorage = (() => {
            let store = {};
            return {
                getItem: (key) => store[key] || null,
                setItem: (key, value) => {
                    store[key] = value.toString();
                },
                removeItem: (key) => {
                    delete store[key];
                },
                clear: () => {
                    store = {};
                }
            };
        })();

        // Override localStorage with mock
        Object.defineProperty(window, 'localStorage', {
            value: mockLocalStorage,
        });

        // Mock the required modules
        const storageManager = {
            _data: {},
            
            getUserData: function() {
                return this._data.userData || null;
            },
            
            setUserData: function(userData) {
                this._data.userData = userData;
            },
            
            getUserHabits: function() {
                return this._data.userHabits || [];
            },
            
            setUserHabits: function(habits) {
                this._data.userHabits = habits;
            },
            
            addUserHabit: function(habit) {
                if (!this._data.userHabits) {
                    this._data.userHabits = [];
                }
                this._data.userHabits.push(habit);
            },
            
            getDailyNutrition: function() {
                return this._data.dailyNutrition || [];
            },
            
            setDailyNutrition: function(nutrition) {
                this._data.dailyNutrition = nutrition;
            },
            
            addDailyNutrition: function(nutrition) {
                if (!this._data.dailyNutrition) {
                    this._data.dailyNutrition = [];
                }
                this._data.dailyNutrition.unshift(nutrition);
            },
            
            getNutritionForDate: function(date) {
                const dailyNutrition = this.getDailyNutrition();
                const dateStr = date.toISOString().split('T')[0];
                return dailyNutrition.find(n => n.date.toISOString().split('T')[0] === dateStr);
            },
            
            getMealPreferences: function(userId) {
                return this._data[`meal_preferences_${userId}`] || {};
            },
            
            setMealPreferences: function(userId, preferences) {
                this._data[`meal_preferences_${userId}`] = preferences;
            },
            
            clearAllData: function() {
                this._data = {};
            }
        };

        const habitTrackingService = {
            getUserHabits: function(userId) {
                const habits = storageManager.getUserHabits();
                return habits.find(habit => habit.userId === userId);
            },
            
            recordWorkoutSession: function(session) {
                // Mock implementation
                console.log('Recorded workout session:', session);
            }
        };

        // Mock nutrition service implementation
        const nutritionService = {
            initializeUserNutritionProfile: function(userId) {
                const habits = storageManager.getUserHabits();
                const existingHabit = habits.find(habit => habit.userId === userId);
                
                if (existingHabit) {
                    return existingHabit;
                }
                
                const newUserHabit = {
                    id: `habit_${userId}_${Date.now()}`,
                    userId,
                    preferredTrainingTimes: [],
                    trainingFrequency: 0,
                    lastTrainingSessions: [],
                    averageTrainingDuration: 0,
                    preferredTrainingDays: [],
                    preferredMealTimes: ['08:00', '13:00', '19:00'],
                    preferredFoods: [],
                    dislikedFoods: [],
                    dietaryRestrictions: [],
                    nutritionGoals: ['maintenance']
                };
                
                storageManager.addUserHabit(newUserHabit);
                return newUserHabit;
            },
            
            updateUserNutritionPreferences: function(userId, preferences) {
                const habits = storageManager.getUserHabits();
                const userHabit = habits.find(habit => habit.userId === userId) || 
                                this.initializeUserNutritionProfile(userId);
                
                if (preferences.preferredFoods) {
                    userHabit.preferredFoods = preferences.preferredFoods;
                }
                
                if (preferences.dislikedFoods) {
                    userHabit.dislikedFoods = preferences.dislikedFoods;
                }
                
                if (preferences.dietaryRestrictions) {
                    userHabit.dietaryRestrictions = preferences.dietaryRestrictions;
                }
                
                if (preferences.nutritionGoals) {
                    userHabit.nutritionGoals = preferences.nutritionGoals;
                }
                
                if (preferences.preferredMealTimes) {
                    userHabit.preferredMealTimes = preferences.preferredMealTimes;
                }
                
                const updatedHabits = habits.map(habit => 
                    habit.userId === userId ? userHabit : habit
                );
                storageManager.setUserHabits(updatedHabits);
            },
            
            calculateDailyNutritionNeeds: function(userId, date) {
                const habit = habitTrackingService.getUserHabits(userId);
                const primaryGoal = (habit?.nutritionGoals?.[0]) || 'maintenance';
                
                // Mock calculation
                const baseNutrients = {
                    calories: 2000,
                    protein: 150,
                    carbs: 250,
                    fats: 70
                };
                
                // Mock meals
                const meals = [
                    {
                        id: 'meal_1',
                        type: 'breakfast',
                        name: 'High Protein Breakfast',
                        time: '08:00',
                        nutrients: { calories: 400, protein: 25, carbs: 50, fats: 15 },
                        ingredients: ['Oatmeal', 'Egg Whites', 'Berries', 'Greek Yogurt'],
                        date: date
                    },
                    {
                        id: 'meal_2',
                        type: 'lunch',
                        name: 'Lean Protein Lunch',
                        time: '13:00',
                        nutrients: { calories: 600, protein: 40, carbs: 60, fats: 20 },
                        ingredients: ['Chicken Breast', 'Quinoa', 'Vegetables', 'Avocado'],
                        date: date
                    },
                    {
                        id: 'meal_3',
                        type: 'dinner',
                        name: 'Balanced Dinner',
                        time: '19:00',
                        nutrients: { calories: 500, protein: 35, carbs: 40, fats: 18 },
                        ingredients: ['Salmon', 'Broccoli', 'Sweet Potato', 'Olive Oil'],
                        date: date
                    }
                ];
                
                return {
                    date,
                    totalNutrients: baseNutrients,
                    meals,
                    calorieExpenditure: 300,
                    nutritionGoal: primaryGoal
                };
            },
            
            learnFromMealPreferences: function(userId, meal) {
                const habits = storageManager.getUserHabits();
                const userHabit = habits.find(habit => habit.userId === userId) || 
                                this.initializeUserNutritionProfile(userId);
                
                meal.ingredients.forEach(ingredient => {
                    if (!userHabit.preferredFoods.includes(ingredient)) {
                        userHabit.preferredFoods.push(ingredient);
                    }
                });
                
                const updatedHabits = habits.map(habit => 
                    habit.userId === userId ? userHabit : habit
                );
                storageManager.setUserHabits(updatedHabits);
            },
            
            getPersonalizedIngredients: function(userId, mealType, goal) {
                const baseIngredients = {
                    breakfast: ['Oatmeal', 'Eggs', 'Berries', 'Greek Yogurt'],
                    lunch: ['Chicken', 'Quinoa', 'Vegetables', 'Avocado'],
                    dinner: ['Salmon', 'Broccoli', 'Sweet Potato', 'Olive Oil']
                };
                
                return baseIngredients[mealType] || ['Protein', 'Carbs', 'Fats'];
            },
            
            getNutritionRecommendations: function(userId, date) {
                const existingNutrition = storageManager.getNutritionForDate(date);
                if (existingNutrition) {
                    return existingNutrition;
                }
                
                const nutritionData = this.calculateDailyNutritionNeeds(userId, date);
                storageManager.addDailyNutrition(nutritionData);
                return nutritionData;
            }
        };

        function runTests() {
            const results = document.getElementById('results');
            results.innerHTML = 'Running tests...\n\n';
            
            try {
                // Test 1: Initialize user nutrition profile
                results.innerHTML += '1. Initializing user nutrition profile...\n';
                const userId = 'test-user';
                const habit = nutritionService.initializeUserNutritionProfile(userId);
                results.innerHTML += '   ✅ User nutrition profile initialized\n';
                results.innerHTML += `   📋 Preferred meal times: ${JSON.stringify(habit.preferredMealTimes)}\n`;
                results.innerHTML += `   🎯 Nutrition goals: ${JSON.stringify(habit.nutritionGoals)}\n\n`;
                
                // Test 2: Update user nutrition preferences
                results.innerHTML += '2. Updating user nutrition preferences...\n';
                const preferences = {
                    preferredFoods: ['Chicken', 'Rice', 'Broccoli'],
                    dislikedFoods: ['Spinach'],
                    dietaryRestrictions: ['Gluten-free'],
                    nutritionGoals: ['muscle_mass'],
                    preferredMealTimes: ['07:00', '12:00', '18:00']
                };
                
                nutritionService.updateUserNutritionPreferences(userId, preferences);
                const updatedHabit = habitTrackingService.getUserHabits(userId);
                results.innerHTML += '   ✅ User nutrition preferences updated\n';
                results.innerHTML += `   🍗 Preferred foods: ${JSON.stringify(updatedHabit.preferredFoods)}\n`;
                results.innerHTML += `   🚫 Disliked foods: ${JSON.stringify(updatedHabit.dislikedFoods)}\n`;
                results.innerHTML += `   🚨 Dietary restrictions: ${JSON.stringify(updatedHabit.dietaryRestrictions)}\n`;
                results.innerHTML += `   🎯 Nutrition goals: ${JSON.stringify(updatedHabit.nutritionGoals)}\n\n`;
                
                // Test 3: Calculate daily nutrition needs
                results.innerHTML += '3. Calculating daily nutrition needs...\n';
                const date = new Date();
                const dailyNutrition = nutritionService.calculateDailyNutritionNeeds(userId, date);
                results.innerHTML += '   ✅ Daily nutrition needs calculated\n';
                results.innerHTML += `   🔥 Calories: ${dailyNutrition.totalNutrients.calories}\n`;
                results.innerHTML += `   🥩 Protein: ${dailyNutrition.totalNutrients.protein}g\n`;
                results.innerHTML += `   🍞 Carbs: ${dailyNutrition.totalNutrients.carbs}g\n`;
                results.innerHTML += `   🧈 Fats: ${dailyNutrition.totalNutrients.fats}g\n`;
                results.innerHTML += `   🎯 Nutrition goal: ${dailyNutrition.nutritionGoal}\n\n`;
                
                // Test 4: Generate meals for the day
                results.innerHTML += '4. Generating meals for the day...\n';
                results.innerHTML += `   🍽️ Total meals generated: ${dailyNutrition.meals.length}\n`;
                dailyNutrition.meals.forEach((meal, index) => {
                    results.innerHTML += `   ${index + 1}. ${meal.name} (${meal.type}) - ${meal.nutrients.calories} kcal at ${meal.time}\n`;
                });
                results.innerHTML += '\n';
                
                // Test 5: Learn from meal preferences
                results.innerHTML += '5. Learning from meal preferences...\n';
                const sampleMeal = {
                    id: 'test-meal',
                    type: 'lunch',
                    name: 'Protein Bowl',
                    time: '12:00',
                    nutrients: {
                        calories: 500,
                        protein: 40,
                        carbs: 30,
                        fats: 15
                    },
                    ingredients: ['Chicken', 'Quinoa', 'Vegetables'],
                    date: new Date()
                };
                
                nutritionService.learnFromMealPreferences(userId, sampleMeal);
                const habitAfterLearning = habitTrackingService.getUserHabits(userId);
                results.innerHTML += '   ✅ Learned from meal preferences\n';
                results.innerHTML += `   📚 Updated preferred foods: ${JSON.stringify(habitAfterLearning.preferredFoods)}\n\n`;
                
                // Test 6: Get personalized ingredients
                results.innerHTML += '6. Getting personalized ingredients...\n';
                const personalizedIngredients = nutritionService.getPersonalizedIngredients(userId, 'dinner', 'muscle_mass');
                results.innerHTML += '   ✅ Personalized ingredients retrieved\n';
                results.innerHTML += `   🥘 Dinner ingredients: ${JSON.stringify(personalizedIngredients)}\n\n`;
                
                // Test 7: Store and retrieve daily nutrition data
                results.innerHTML += '7. Storing and retrieving daily nutrition data...\n';
                storageManager.addDailyNutrition(dailyNutrition);
                const retrievedData = storageManager.getNutritionForDate(date);
                results.innerHTML += '   ✅ Daily nutrition data stored and retrieved\n';
                results.innerHTML += `   📅 Retrieved date: ${retrievedData.date.toDateString()}\n`;
                results.innerHTML += `   🔥 Retrieved calories: ${retrievedData.totalNutrients.calories}\n\n`;
                
                results.innerHTML += '🎉 All nutrition system tests passed!\n';
                results.innerHTML += '✅ The intelligent nutrition system is working correctly.\n';
                
            } catch (error) {
                results.innerHTML += `❌ Test failed with error: ${error.message}\n`;
                results.innerHTML += `Stack trace: ${error.stack}\n`;
            }
        }
    </script>
</body>
</html>